<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><meta content=#ffffff name=theme-color><meta content=#da532c name=msapplication-TileColor><link href=/icons/site.webmanifest rel=manifest><link color=#5bbad5 href=/icons/safari-pinned-tab.svg rel=mask-icon><link href=/icons/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/icons/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/icons/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link crossorigin=anonymous href=https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1.9.1/css/academicons.min.css integrity=sha384-FIue+PI4SsI9XfHCz8dBLg33b0c1fMJgNU3X//L26FYbGnlSEfWmNT7zgWc2N9b6 rel=stylesheet><link integrity="sha256-AbA177XfpSnFEvgpYu1jMygiLabzPCJCRIBtR5jGc0k=" crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css rel=stylesheet><link href=/deep-thought.css rel=stylesheet><title> Youmu | TikZ Externalization for Beamer </title><link crossorigin=anonymous href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs rel=stylesheet><script crossorigin=anonymous defer integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script><script crossorigin=anonymous defer integrity=sha384-jiBVvJ8NGGj5n7kJaiWwWp9AjC+Yh8rhZY3GtAX8yU28azcLgoRo4oukO87g7zDT src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/mathtex-script-type.min.js></script><script crossorigin=anonymous defer integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js></script><body class=has-background-white><nav aria-label="section navigation" class="navbar is-light" role=navigation><div class=container><div class=navbar-brand><a class="navbar-item is-size-5 has-text-weight-bold" href=/>Youmu</a><a class="navbar-burger burger" aria-expanded=false aria-label=menu data-target=navMenu role=button> <span aria-hidden=true></span> <span aria-hidden=true></span> <span aria-hidden=true></span> </a></div><div class=navbar-menu id=navMenu><div class="navbar-end has-text-centered"><a class="navbar-item has-text-weight-semibold" href=/> Home </a><a class="navbar-item has-text-weight-semibold" href=/posts> Posts </a><a class="navbar-item has-text-weight-semibold" href=/tags> Tags </a><a class="navbar-item has-text-weight-semibold" href=/categories> Categories </a><a class=navbar-item data-target=#search-modal id=nav-search title=Search> <span class=icon> <i class="fas fa-search"></i> </span> </a><a title="Switch to dark theme" class=navbar-item id=dark-mode> <span class=icon> <i class="fas fa-adjust"></i> </span> </a></div></div></div></nav><section class=section><div class=container><div class=columns><div class="column is-8 is-offset-2"><article class=box><h1 class=title>TikZ Externalization for Beamer</h1><p class=subtitle>Compile a single file if the figure doesn't change across overlays<div class="columns is-multiline is-gapless"><div class="column is-8"><span class="icon-text has-text-grey"> <span class=icon> <i class="fas fa-user"></i> </span> <span>妖夢ちゃん published on</span> <span class=icon> <i class="far fa-calendar-alt"></i> </span> <span><time datetime=2021-10-27>October 27, 2021</time></span> </span></div><div class="column is-4 has-text-right-desktop"><span class="icon-text has-text-grey"> <span class=icon> <i class="far fa-clock"></i> </span> <span>7 min,</span> <span class=icon> <i class="fas fa-pencil-alt"></i> </span> <span>1209 words</span> </span></div><div class=column><p>Categories: <a class="has-text-info-dark has-text-weight-semibold" href=/categories/research/> <span class=icon-text> <span class=icon> <i class="fas fa-cube"></i> </span> <span>Research</span> </span> </a></div><div class="column has-text-right-desktop"><p>Tags: <a class="has-text-info-dark has-text-weight-semibold" href=/tags/latex/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>latex</span> </span> </a> <a class="has-text-info-dark has-text-weight-semibold" href=/tags/tikz/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>tikz</span> </span> </a> <a class="has-text-info-dark has-text-weight-semibold" href=/tags/beamer/> <span class=icon-text> <span class=icon> <i class="fas fa-tag"></i> </span> <span>beamer</span> </span> </a></div></div><div class="content mt-2"><p>Recently I made a presentation for a talk on <a rel="noopener nofollow noreferrer" href=https://comptag.github.io/fwcg21/ target=_blank>FWCG2021</a>. As always I went to Beamer. What was different this time was that I needed many figures, I mean, a lot. On top of that, I wanted to do overlays on these figures. Overleaf timed out when trying to compile all the TikZ figures so I turned to <a rel="noopener nofollow noreferrer" href=https://www.overleaf.com/learn/latex/Questions/I_have_a_lot_of_tikz%2C_matlab2tikz_or_pgfplots_figures%2C_so_I%27m_getting_a_compilation_timeout._Can_I_externalise_my_figures%3F target=_blank><code>external</code></a>. There are a lot of files to generate when I built the presentation locally and it was unbearably slow. Maybe there's a way to reduce the time, at least a little bit?</p><span id=continue-reading></span><h1 id=vanilla-tikz-externalization>Vanilla TikZ Externalization</h1><p>Using the vanilla TikZ externalization is easy, simply put<pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#66d9ef;>\usetikzlibrary</span><span>{external}
</span><span style=color:#66d9ef;>\tikzexternalize </span><span style=color:#75715e;>% or optionally \tikzexternalize[prefix=some_directory/]
</span></code></pre><p>in the <code>main.tex</code>. Now the LaTeX compiler will spawn another process to compile a TikZ environment into some separated files whenever it encounters one.<p>Properties of the vanilla approach:<ul><li>By default, the name of the files generating by an environment will be <code>figure-{num}</code>, where <code>{num}</code> is automatically incremented. Using <code>\tikzsetnextfilename</code> could set the file name, but the "same" environment in later overlays will not be generated since they have the same name and TikZ doesn't think they are different.<li>Each TikZ environment generates 4 files: <ol><li><code>{name}.log</code>: the log of the individual process compiling this environment.<li><code>{name}.md5</code>: the MD5 hash of the input to the TikZ environment, pre-expaned.<li><code>{name}.dpth</code>: the auxiliary file to include when loading externalized figure.<li><code>{name}.pdf</code>: the generated figure.</ol></ul><p>So if we set up a TikZ figure as follows,<pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span><span>  </span><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}
</span><span>    </span><span style=color:#66d9ef;>\node</span><span>[draw, circle] (n) at (0, 0) {</span><span style=color:#66d9ef;>\alt</span><span>&LT2>{1}{2}};
</span><span>  </span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}
</span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span></code></pre><p>where we want the node label to be <code>1</code> on the first overlay, and <code>2</code> on the second overlay. In this snippet, beamer won't recognize the existence of the second overlay, and only one overlay will be generated.<h1 id=prior-arts>Prior Arts</h1><p>The most immediate problem to solve is to make externalization to generate different figures across overlays. Such question was asked and answered before.<h2 id=without-custom-filename>Without Custom Filename</h2><p>The earliest reference I could find is due to <a rel="noopener nofollow noreferrer" href=https://tex.stackexchange.com/questions/78955/use-tikz-external-feature-with-beamer-only target=_blank>this TeX stackexchange question</a>, in which 2 methods were given. The main idea is to let beamer know how many overlay is needed, and externalization should automatically generate figures for each overlay, with incrementing name.<ul><li><p><a rel="noopener nofollow noreferrer" href=https://tex.stackexchange.com/a/79461/73509 target=_blank>Christian Feuersänger's Solution</a></p> <p>The idea is simple, wrap the TikZ environment by a <code>\only</code> call indicating the number of overlays needed in the frame. So the prior example becomes:</p> <pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span><span>  </span><span style=color:#66d9ef;>\only</span><span>&LT1-2>{</span><span style=color:#75715e;>%
</span><span>    </span><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}
</span><span>      </span><span style=color:#66d9ef;>\node</span><span>[draw, circle] (n) at (0, 0) {</span><span style=color:#66d9ef;>\alt</span><span>&LT2>{1}{2}};
</span><span>    </span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}</span><span style=color:#75715e;>%
</span><span>  }</span><span style=color:#75715e;>%
</span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span></code></pre> <p>One downside is the need to explicitly spell out the required overlays.</p><li><p><a rel="noopener nofollow noreferrer" href=https://tex.stackexchange.com/a/79572/73509 target=_blank>Andrew Stacey's Solution</a></p> <p>The idea is to communicate the need for more overlays in the <code>.dpth</code> file to the main process, and turn off some optimizations to make sure such communication happens. Andrew made a TikZ preset for this:</p> <pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#66d9ef;>\makeatletter
</span><span style=color:#66d9ef;>\tikzset</span><span>{
</span><span>  beamer externalising/.style={</span><span style=color:#75715e;>%
</span><span>    execute at end picture={</span><span style=color:#75715e;>%
</span><span>      </span><span style=color:#66d9ef;>\tikzifexternalizing</span><span>{</span><span style=color:#75715e;>%
</span><span>        </span><span style=color:#66d9ef;>\ifbeamer@anotherslide
</span><span>        </span><span style=color:#66d9ef;>\pgfexternalstorecommand</span><span>{</span><span style=color:#66d9ef;>\string\global\string\beamer@anotherslidetrue</span><span>}</span><span style=color:#75715e;>%
</span><span>        </span><span style=color:#f92672;>\fi
</span><span>      }{}</span><span style=color:#75715e;>%
</span><span>    }</span><span style=color:#75715e;>%
</span><span>  },
</span><span>  external/optimize=false
</span><span>}
</span><span style=color:#66d9ef;>\makeatother
</span></code></pre> <p>And all it takes to use it is just to apply the style for the environment:</p> <pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span><span>  </span><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}[beamer externalising]
</span><span>    </span><span style=color:#66d9ef;>\node</span><span>[draw, circle] (n) at (0, 0) {</span><span style=color:#66d9ef;>\alt</span><span>&LT2>{1}{2}};
</span><span>  </span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}
</span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span></code></pre></ul><p>The main drawbacks of these two solutions are:<ul><li><p>Setting a custom filename for the figure does not work. Consider the following snippet:</p> <pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span><span>  </span><span style=color:#66d9ef;>\tikzsetnextfilename</span><span>{test}
</span><span>  </span><span style=color:#66d9ef;>\only</span><span>&LT1-2>{</span><span style=color:#75715e;>%
</span><span>    </span><span style=color:#f92672;>\begin</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}
</span><span>      </span><span style=color:#66d9ef;>\node</span><span>[draw, circle] (n) at (0, 0) {</span><span style=color:#66d9ef;>\alt</span><span>&LT2>{1}{2}};
</span><span>    </span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>tikzpicture</span><span>}</span><span style=color:#75715e;>%
</span><span>  }</span><span style=color:#75715e;>%
</span><span style=color:#f92672;>\end</span><span>{</span><span style=font-style:italic;color:#fd971f;>frame</span><span>}
</span></code></pre> <ol><li>On overlay 1, <code>test.log</code>, <code>test.md5</code>, <code>test.dpth</code>, and <code>test.pdf</code> are produced, which correctly reflect the first overlay.<li>On overlay 2, the <strong>unexpanded</strong> but canonicalized body of <code>tikzpicture</code> is passed for MD5 digest, which is obviously identical to the previous overlay. The externalization process finds <code>test.md5</code> and deems that it is fine to just use that.</ol> <p>The result is an unchanged figure despite a <code>\alt</code> command in it.</p><li><p>Suppose in a 3-overlay frame the figure only changes in overlay 2, the externalization will still generate 3 figures instead of 2.</p></ul><h2 id=with-custom-filename>With Custom Filename</h2><p>Andrew Stacey addressed the first drawback in <a rel="noopener nofollow noreferrer" href=https://tex.stackexchange.com/a/119440/73509 target=_blank>this question</a>. The idea is simply to attach the overlay number to the name when using <code>\tikzsetnextfilename</code>, so that figures in different overlays get different filenames. It is achieved by simply redefining <code>\tikzsetnextfilename</code> as:<pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#66d9ef;>\let\orig@tikzsetnextfilename</span><span>=</span><span style=color:#66d9ef;>\tikzsetnextfilename
</span><span style=color:#66d9ef;>\renewcommand\tikzsetnextfilename</span><span>[1]{</span><span style=color:#66d9ef;>\orig@tikzsetnextfilename</span><span>{#1-</span><span style=color:#66d9ef;>\overlaynumber</span><span>}}
</span></code></pre><p>The second drawback is still present, and I came up with a partial solution for that.<h1 id=introducing-tikznamebeamer>Introducing <code>\tikznamebeamer</code></h1><p>The idea is to have user to specify different groups of overlay numbers, and generate one figure per group. Here is the implementation:<pre class=language-ltx data-lang=ltx style=background-color:#272822;color:#f8f8f2;><code class=language-ltx data-lang=ltx><span style=color:#f92672;>\usepackage</span><span>{</span><span style=font-style:italic;color:#66d9ef;>etoolbox</span><span>}
</span><span style=color:#66d9ef;>\makeatletter
</span><span style=color:#66d9ef;>\newcounter</span><span>{tikznamebeamer@tempcnt}</span><span style=color:#75715e;>% counter variable to go through groups
</span><span style=color:#f92672;>\def</span><span style=color:#66d9ef;>\tikznamebeamer@finalidx</span><span>{}</span><span style=color:#75715e;>% will store the group index to use
</span><span style=color:#f92672;>\newcommand</span><span>{</span><span style=color:#66d9ef;>\tikznamebeamer</span><span>}[2][figure]{</span><span style=color:#75715e;>%
</span><span>    </span><span style=color:#66d9ef;>\def\tikznamebeamer@slidesetidx</span><span>{</span><span style=color:#75715e;>%
</span><span>        </span><span style=color:#66d9ef;>\setcounter</span><span>{tikznamebeamer@tempcnt}{0}</span><span style=color:#75715e;>% reset counter
</span><span>        </span><span style=color:#66d9ef;>\let\tikznamebeamer@finalidx</span><span>=0</span><span style=color:#75715e;>% default group being 0
</span><span>        </span><span style=color:#66d9ef;>\renewcommand</span><span>*{</span><span style=color:#66d9ef;>\do</span><span>}[1]{</span><span style=color:#75715e;>% loop
</span><span>            </span><span style=color:#66d9ef;>\stepcounter</span><span>{tikznamebeamer@tempcnt}</span><span style=color:#75715e;>% counter++
</span><span>            </span><span style=color:#66d9ef;>\let\tikznamebeamer@templist</span><span>=</span><span style=color:#66d9ef;>\relax</span><span style=color:#75715e;>%
</span><span>            </span><span style=color:#66d9ef;>\forcsvlist</span><span>{</span><span style=color:#66d9ef;>\listadd\tikznamebeamer@templist</span><span>}{####1}</span><span style=color:#75715e;>% iterate through list of overlay numbers
</span><span>            </span><span style=color:#66d9ef;>\xifinlist</span><span>{</span><span style=color:#66d9ef;>\number\beamer@slideinframe</span><span>}{</span><span style=color:#66d9ef;>\tikznamebeamer@templist</span><span>}{</span><span style=color:#75715e;>%
</span><span>                </span><span style=color:#66d9ef;>\edef\tikznamebeamer@finalidx</span><span>{</span><span style=color:#66d9ef;>\thetikznamebeamer@tempcnt</span><span>}</span><span style=color:#75715e;>% found, set group number
</span><span>            }{}</span><span style=color:#75715e;>%
</span><span>        }</span><span style=color:#75715e;>%
</span><span>        </span><span style=color:#66d9ef;>\docsvlist</span><span>{#2}</span><span style=color:#75715e;>% iterate through a list of lists of overlay numbers
</span><span>    }</span><span style=color:#75715e;>%
</span><span>    </span><span style=color:#66d9ef;>\tikznamebeamer@slidesetidx</span><span style=color:#75715e;>%
</span><span>    </span><span style=color:#66d9ef;>\tikzsetnextfilename</span><span>{#1-</span><span style=color:#66d9ef;>\tikznamebeamer@finalidx</span><span>}</span><span style=color:#75715e;>%
</span><span>}
</span><span style=color:#66d9ef;>\makeatother
</span></code></pre><p><code>\tikznamebeamer</code> accepts two arguments. The first argument is the desired filename. The second argument is a list of lists of numbers. For example, suppose the current frame has 5 overlays, <code>{{2, 5}, 4}</code> defines <strong>3</strong> groups (note that any overlay number of specified goes to group 0):<ul><li>group 0 (default): 1, 3<li>gruop 1: 2, 5<li>group 2: 4</ul><p>Hence a call <code>\tikznamebeamer[my-graph]{{2, 5}, 4}</code> in this case will create 3 sets of files with name <code>my-graph-0</code>, <code>my-graph-1</code>, and <code>my-graph-2</code>. Overlay will use the correct set of files according to its group number.<p>In this way, we can both specify a custom filename, and avoid unnecessary compilation at the same time.<h1 id=future-directions>Future Directions</h1><p>It is quite tedious to manually specify what overlay numbers have the same figure. Ideally the externalization should:<ol><li>Hash the canonicalized body of <code>tikzpicture</code> <strong>after expanding beamer related macros</strong>.<li>Match the hash within the generated files to decide whether to create a new one or not.</ol><p>I haven't figured out the expanding part yet. But here are some thoughts on the second part:<ul><li>One simple idea is to append the hash to the end of the filename. Downside is that the figure could be frequently edited, and old files quickly bloat the build directory.<li>Another more practical idea is to store a mapping between hash and filename in memory. This seems much more complicated to implement though.</ul><p>Of course the elephant in the room is that the compilation is single-threaded, where the TikZ compilation chould've been done in parallel. There are some techniques involving using a custom build system for figures but that does not play too well on Overleaf.</div></article></div><div class="column is-2 is-hidden-mobile"><aside style="position: sticky; top: 48px" class=menu><p class="heading has-text-weight-bold">Contents<ul class=menu-list><li><a class="toc is-size-7 is-active" href=/posts/tikz-externalization-reuse-for-beamer/#vanilla-tikz-externalization id=link-vanilla-tikz-externalization> Vanilla TikZ Externalization </a><li><a class="toc is-size-7" href=/posts/tikz-externalization-reuse-for-beamer/#prior-arts id=link-prior-arts> Prior Arts </a> <ul><li><a class="toc is-size-7" href=/posts/tikz-externalization-reuse-for-beamer/#without-custom-filename id=link-without-custom-filename> Without Custom Filename </a><li><a class="toc is-size-7" href=/posts/tikz-externalization-reuse-for-beamer/#with-custom-filename id=link-with-custom-filename> With Custom Filename </a></ul><li><a class="toc is-size-7" href=/posts/tikz-externalization-reuse-for-beamer/#introducing-tikznamebeamer id=link-introducing-tikznamebeamer> Introducing \tikznamebeamer </a><li><a class="toc is-size-7" href=/posts/tikz-externalization-reuse-for-beamer/#future-directions id=link-future-directions> Future Directions </a></ul></aside></div></div></div></section><section class=modal id=search-modal><div class=modal-background></div><div class=modal-card><header class=modal-card-head><p class=modal-card-title>Search</header><section class=modal-card-body><div class="field mb-2"><div class=control><input placeholder="Search this website." class=input id=search type=search></div></div><div class=search-results><div class=search-results__items></div></div></section></div><button class="modal-close is-large" aria-label=close></button></section><footer class="footer py-4"><div class="content has-text-centered"><p>Built with <span class=icon-text> <span class=icon> <i class="fas fa-code"></i> </span> <span>code</span> </span> and <span class=icon-text> <span class=icon> <i class="fas fa-heart"></i> </span> <span>love</span> </span><p>Powered by <span class=icon-text> <span class=icon> <i class="fas fa-power-off"></i> </span> <span>zola</span> </span></div></footer><script src=/elasticlunr.min.js></script><script src=/search_index.en.js></script><script src=/js/site.js></script><script>const menuBarHeight = document.querySelector("nav.navbar").clientHeight;
  const tocItems = document.querySelectorAll(".toc");
  const navSections = new Array(tocItems.length);

  tocItems.forEach((el, i) => {
    let id = el.getAttribute("id").substring(5);
    navSections[i] = document.getElementById(id);
  })

  function isVisible(tocIndex) {
    const current = navSections[tocIndex];
    const next = tocIndex < tocItems.length - 1 ? navSections[tocIndex + 1]
      : document.querySelectorAll("section.section").item(1);

    const c = current.getBoundingClientRect();
    const n = next.getBoundingClientRect();
    const h = (window.innerHeight || document.documentElement.clientHeight);

    return (c.top <= h) && (n.top - menuBarHeight >= 0);
  }

  function activateIfVisible() {
    for (b = true, i = 0; i < tocItems.length; i++) {
      if (b && isVisible(i)) {
        tocItems[i].classList.add('is-active');
        b = false;
      } else
        tocItems[i].classList.remove('is-active');
    }
  }

  var isTicking = null;
  window.addEventListener('scroll', () => {
    if (!isTicking) {
      window.requestAnimationFrame(() => {
        activateIfVisible();
        isTicking = false;
      });
      isTicking = true;
    }
  }, false);</script>